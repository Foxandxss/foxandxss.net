/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function t(t){return t.type==CKEDITOR.NODE_TEXT&&t.getLength()>0&&(!e||!t.isReadOnly())}function n(e){return e.type!=CKEDITOR.NODE_ELEMENT||!e.isBlockBoundary(CKEDITOR.tools.extend({},CKEDITOR.dtd.$empty,CKEDITOR.dtd.$nonEditable))}function o(e){var t,n,r,o;t=e==="find"?1:0,n=1-t;var u,a=s.length;for(u=0;u<a;u++)r=this.getContentElement(i[t],s[u][t]),o=this.getContentElement(i[n],s[u][n]),o.setValue(r.getValue())}var e,r=function(){var e=this;return{textNode:e.textNode,offset:e.offset,character:e.textNode?e.textNode.getText().charAt(e.offset):null,hitMatchBoundary:e._.matchBoundary}},i=["find","replace"],s=[["txtFindFind","txtFindReplace"],["txtFindCaseChk","txtReplaceCaseChk"],["txtFindWordChk","txtReplaceWordChk"],["txtFindCyclic","txtReplaceCyclic"]],u=function(i,s){function h(e,t){var n=new CKEDITOR.dom.range;return n.setStart(e.textNode,t?e.offset:e.offset+1),n.setEndAt(i.document.getBody(),CKEDITOR.POSITION_BEFORE_END),n}function p(e){var t=new CKEDITOR.dom.range;return t.setStartAt(i.document.getBody(),CKEDITOR.POSITION_AFTER_START),t.setEnd(e.textNode,e.offset),t}function T(e){var t,n=i.getSelection(),r=i.document.getBody();return n&&!e?(t=n.getRanges()[0].clone(),t.collapse(!0)):(t=new CKEDITOR.dom.range,t.setStartAt(r,CKEDITOR.POSITION_AFTER_START)),t.setEndAt(r,CKEDITOR.POSITION_BEFORE_END),t}var u=new CKEDITOR.style(CKEDITOR.tools.extend({attributes:{"data-cke-highlight":1},fullMatch:1,ignoreReadonly:1,childRule:function(){return 0}},i.config.find_highlight,!0)),f=function(e,r){var i=this,s=new CKEDITOR.dom.walker(e);s.guard=r?n:function(e){!n(e)&&(i._.matchBoundary=!0)},s.evaluator=t,s.breakOnFalse=1,e.startContainer.type==CKEDITOR.NODE_TEXT&&(this.textNode=e.startContainer,this.offset=e.startOffset-1),this._={matchWord:r,walker:s,matchBoundary:!1}};f.prototype={next:function(){return this.move()},back:function(){return this.move(!0)},move:function(e){var t=this,n=t.textNode;if(n===null)return r.call(t);t._.matchBoundary=!1;if(n&&e&&t.offset>0)return t.offset--,r.call(t);if(n&&t.offset<n.getLength()-1)return t.offset++,r.call(t);n=null;while(!n){n=t._.walker[e?"previous":"next"].call(t._.walker);if(t._.matchWord&&!n||t._.walker._.end)break}return t.textNode=n,n?t.offset=e?n.getLength()-1:0:t.offset=0,r.call(t)}};var l=function(e,t){this._={walker:e,cursors:[],rangeLength:t,highlightRange:null,isMatched:0}};l.prototype={toDomRange:function(){var e=new CKEDITOR.dom.range(i.document),t=this._.cursors;if(t.length<1){var n=this._.walker.textNode;if(!n)return null;e.setStartAfter(n)}else{var r=t[0],s=t[t.length-1];e.setStart(r.textNode,r.offset),e.setEnd(s.textNode,s.offset+1)}return e},updateFromDomRange:function(e){var t=this,n,r=new f(e);t._.cursors=[];do n=r.next(),n.character&&t._.cursors.push(n);while(n.character);t._.rangeLength=t._.cursors.length},setMatched:function(){this._.isMatched=!0},clearMatched:function(){this._.isMatched=!1},isMatched:function(){return this._.isMatched},highlight:function(){var e=this;if(e._.cursors.length<1)return;e._.highlightRange&&e.removeHighlight();var t=e.toDomRange(),n=t.createBookmark();u.applyToRange(t),t.moveToBookmark(n),e._.highlightRange=t;var r=t.startContainer;r.type!=CKEDITOR.NODE_ELEMENT&&(r=r.getParent()),r.scrollIntoView(),e.updateFromDomRange(t)},removeHighlight:function(){var e=this;if(!e._.highlightRange)return;var t=e._.highlightRange.createBookmark();u.removeFromRange(e._.highlightRange),e._.highlightRange.moveToBookmark(t),e.updateFromDomRange(e._.highlightRange),e._.highlightRange=null},isReadOnly:function(){return this._.highlightRange?this._.highlightRange.startContainer.isReadOnly():0},moveBack:function(){var e=this,t=e._.walker.back(),n=e._.cursors;return t.hitMatchBoundary&&(e._.cursors=n=[]),n.unshift(t),n.length>e._.rangeLength&&n.pop(),t},moveNext:function(){var e=this,t=e._.walker.next(),n=e._.cursors;return t.hitMatchBoundary&&(e._.cursors=n=[]),n.push(t),n.length>e._.rangeLength&&n.shift(),t},getEndCharacter:function(){var e=this._.cursors;return e.length<1?null:e[e.length-1].character},getNextCharacterRange:function(e){var t,n,r=this._.cursors;return(t=r[r.length-1])&&t.textNode?n=new f(h(t)):n=this._.walker,new l(n,e)},getCursors:function(){return this._.cursors}};var v=0,m=1,y=2,w=function(e,t){var n=[-1];t&&(e=e.toLowerCase());for(var r=0;r<e.length;r++){n.push(n[r]+1);while(n[r+1]>0&&e.charAt(r)!=e.charAt(n[r+1]-1))n[r+1]=n[n[r+1]-1]+1}this._={overlap:n,state:0,ignoreCase:!!t,pattern:e}};w.prototype={feedCharacter:function(e){var t=this;t._.ignoreCase&&(e=e.toLowerCase());for(;;){if(e==t._.pattern.charAt(t._.state))return t._.state++,t._.state==t._.pattern.length?(t._.state=0,y):m;if(!t._.state)return v;t._.state=t._.overlap[t._.state]}return null},reset:function(){this._.state=0}};var E=/[.,"'?!;: \u0085\u00a0\u1680\u280e\u2028\u2029\u202f\u205f\u3000]/,S=function(e){if(!e)return!0;var t=e.charCodeAt(0);return t>=9&&t<=13||t>=8192&&t<=8202||E.test(e)},x={searchRange:null,matchRange:null,find:function(e,t,n,r,i,s){var o=this;o.matchRange?(o.matchRange.removeHighlight(),o.matchRange=o.matchRange.getNextCharacterRange(e.length)):o.matchRange=new l(new f(o.searchRange),e.length);var u=new w(e,!t),a=v,c="%";while(c!==null){o.matchRange.moveNext();while(c=o.matchRange.getEndCharacter()){a=u.feedCharacter(c);if(a==y)break;o.matchRange.moveNext().hitMatchBoundary&&u.reset()}if(a==y){if(n){var d=o.matchRange.getCursors(),m=d[d.length-1],g=d[0],b=p(g),E=h(m);b.trim(),E.trim();var x=new f(b,!0),N=new f(E,!0);if(!S(x.back().character)||!S(N.next().character))continue}return o.matchRange.setMatched(),i!==!1&&o.matchRange.highlight(),!0}}return o.matchRange.clearMatched(),o.matchRange.removeHighlight(),r&&!s?(o.searchRange=T(1),o.matchRange=null,arguments.callee.apply(o,Array.prototype.slice.call(arguments).concat([!0]))):!1},replaceCounter:0,replace:function(t,n,r,s,o,u,f){var l=this;e=1;var c=0;if(l.matchRange&&l.matchRange.isMatched()&&!l.matchRange._.isReplaced&&!l.matchRange.isReadOnly()){l.matchRange.removeHighlight();var h=l.matchRange.toDomRange(),p=i.document.createText(r);if(!f){var d=i.getSelection();d.selectRanges([h]),i.fire("saveSnapshot")}h.deleteContents(),h.insertNode(p),f||(d.selectRanges([h]),i.fire("saveSnapshot")),l.matchRange.updateFromDomRange(h),f||l.matchRange.highlight(),l.matchRange._.isReplaced=!0,l.replaceCounter++,c=1}else c=l.find(n,s,o,u,!f);return e=0,c}},N=i.lang.findAndReplace;return{title:N.title,resizable:CKEDITOR.DIALOG_RESIZE_NONE,minWidth:350,minHeight:170,buttons:[CKEDITOR.dialog.cancelButton],contents:[{id:"find",label:N.find,title:N.find,accessKey:"",elements:[{type:"hbox",widths:["230px","90px"],children:[{type:"text",id:"txtFindFind",label:N.findWhat,isChanged:!1,labelLayout:"horizontal",accessKey:"F"},{type:"button",id:"btnFind",align:"left",style:"width:100%",label:N.find,onClick:function(){var e=this.getDialog();x.find(e.getValueOf("find","txtFindFind"),e.getValueOf("find","txtFindCaseChk"),e.getValueOf("find","txtFindWordChk"),e.getValueOf("find","txtFindCyclic"))||alert(N.notFoundMsg)}}]},{type:"fieldset",label:CKEDITOR.tools.htmlEncode(N.findOptions),style:"margin-top:29px",children:[{type:"vbox",padding:0,children:[{type:"checkbox",id:"txtFindCaseChk",isChanged:!1,label:N.matchCase},{type:"checkbox",id:"txtFindWordChk",isChanged:!1,label:N.matchWord},{type:"checkbox",id:"txtFindCyclic",isChanged:!1,"default":!0,label:N.matchCyclic}]}]}]},{id:"replace",label:N.replace,accessKey:"M",elements:[{type:"hbox",widths:["230px","90px"],children:[{type:"text",id:"txtFindReplace",label:N.findWhat,isChanged:!1,labelLayout:"horizontal",accessKey:"F"},{type:"button",id:"btnFindReplace",align:"left",style:"width:100%",label:N.replace,onClick:function(){var e=this.getDialog();x.replace(e,e.getValueOf("replace","txtFindReplace"),e.getValueOf("replace","txtReplace"),e.getValueOf("replace","txtReplaceCaseChk"),e.getValueOf("replace","txtReplaceWordChk"),e.getValueOf("replace","txtReplaceCyclic"))||alert(N.notFoundMsg)}}]},{type:"hbox",widths:["230px","90px"],children:[{type:"text",id:"txtReplace",label:N.replaceWith,isChanged:!1,labelLayout:"horizontal",accessKey:"R"},{type:"button",id:"btnReplaceAll",align:"left",style:"width:100%",label:N.replaceAll,isChanged:!1,onClick:function(){var e=this.getDialog(),t;x.replaceCounter=0,x.searchRange=T(1),x.matchRange&&(x.matchRange.removeHighlight(),x.matchRange=null),i.fire("saveSnapshot");while(x.replace(e,e.getValueOf("replace","txtFindReplace"),e.getValueOf("replace","txtReplace"),e.getValueOf("replace","txtReplaceCaseChk"),e.getValueOf("replace","txtReplaceWordChk"),!1,!0));x.replaceCounter?(alert(N.replaceSuccessMsg.replace(/%1/,x.replaceCounter)),i.fire("saveSnapshot")):alert(N.notFoundMsg)}}]},{type:"fieldset",label:CKEDITOR.tools.htmlEncode(N.findOptions),children:[{type:"vbox",padding:0,children:[{type:"checkbox",id:"txtReplaceCaseChk",isChanged:!1,label:N.matchCase},{type:"checkbox",id:"txtReplaceWordChk",isChanged:!1,label:N.matchWord},{type:"checkbox",id:"txtReplaceCyclic",isChanged:!1,"default":!0,label:N.matchCyclic}]}]}]}],onLoad:function(){var e=this,t,n,r=0;this.on("hide",function(){r=0}),this.on("show",function(){r=1}),this.selectPage=CKEDITOR.tools.override(this.selectPage,function(i){return function(s){i.call(e,s);var u=e._.tabs[s],a,f,l;f=s==="find"?"txtFindFind":"txtFindReplace",l=s==="find"?"txtFindWordChk":"txtReplaceWordChk",t=e.getContentElement(s,f),n=e.getContentElement(s,l),u.initialized||(a=CKEDITOR.document.getById(t._.inputId),u.initialized=!0),r&&o.call(this,s)}})},onShow:function(){var e=this;x.searchRange=T();var t=e.getParentEditor().getSelection().getSelectedText(),n=s=="find"?"txtFindFind":"txtFindReplace",r=e.getContentElement(s,n);r.setValue(t),r.select(),e.selectPage(s),e[(s=="find"&&e._.editor.readOnly?"hide":"show")+"Page"]("replace")},onHide:function(){var e;x.matchRange&&x.matchRange.isMatched()&&(x.matchRange.removeHighlight(),i.focus(),e=x.matchRange.toDomRange(),e&&i.getSelection().selectRanges([e])),delete x.matchRange},onFocus:function(){return s=="replace"?this.getContentElement("replace","txtFindReplace"):this.getContentElement("find","txtFindFind")}}};CKEDITOR.dialog.add("find",function(e){return u(e,"find")}),CKEDITOR.dialog.add("replace",function(e){return u(e,"replace")})})();