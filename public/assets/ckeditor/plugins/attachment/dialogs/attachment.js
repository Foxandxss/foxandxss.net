(function(){CKEDITOR.dialog.add("attachment",function(e){function i(e){var t=e.split("/").pop(),n=t.split(".").pop();return{filename:t,className:"attach_"+n}}var t=/^(_(?:self|top|parent|blank))$/,n=function(e,n){var r=n?n.getAttribute("_cke_saved_href")||n.getAttribute("href"):"",i,s,o,u={};u.type="url",u.url=r;if(n){var a=n.getAttribute("target");u.target={};if(a){var f=a.match(t);f?u.target.type=u.target.name=a:(u.target.type="frame",u.target.name=a)}var l=this;u.title=n.getAttribute("title")}var c=e.document.getElementsByTag("img"),h=new CKEDITOR.dom.nodeList(e.document.$.anchors),p=u.anchors=[];for(var d=0;d<c.count();d++){var v=c.getItem(d);v.getAttribute("_cke_realelement")&&v.getAttribute("_cke_real_element_type")=="anchor"&&p.push(e.restoreRealElement(v))}for(d=0;d<h.count();d++)p.push(h.getItem(d));for(d=0;d<p.length;d++)v=p[d],p[d]={name:v.getAttribute("name"),id:v.getAttribute("id")};return this._.selectedElement=n,u},r=function(){var t=this.getDialog(),n=t.getContentElement("general","linkTargetName"),r=this.getValue();if(!n)return;n.setLabel(e.lang.link.targetFrameName),this.getDialog().setValueOf("general","linkTargetName",r.charAt(0)=="_"?r:"")};return{title:e.lang.attachment.title,minWidth:420,minHeight:200,onShow:function(){this.fakeObj=!1;var e=this.getParentEditor(),t=e.getSelection(),r=t.getRanges(),i=null,s=this;if(r.length==1){var o=r[0].getCommonAncestor(!0);i=o.getAscendant("a",!0),i&&i.getAttribute("href")?t.selectElement(i):(i=o.getAscendant("img",!0))&&i.getAttribute("_cke_real_element_type")&&i.getAttribute("_cke_real_element_type")=="anchor"?(this.fakeObj=i,i=e.restoreRealElement(this.fakeObj),t.selectElement(this.fakeObj)):i=null}this.setupContent(n.apply(this,[e,i]))},onOk:function(){var e={href:"javascript:void(0)/*"+CKEDITOR.tools.getNextNumber()+"*/"},t=[],n={href:e.href},r=this,s=this.getParentEditor();this.commitContent(n);var o=n.url||"";e._cke_saved_href=o.indexOf("/")===0?o:"http://"+o;var u=i(o),a=n.title||"";e.title=n.title.length==0?u.filename:n.title,e["class"]=u.className,n.target&&(n.target.type!="notSet"&&n.target.name?e.target=n.target.name:t.push("target"),t.push("_cke_pa_onclick","onclick"));if(!this._.selectedElement){var f=s.getSelection(),l=f.getRanges();if(l.length==1&&l[0].collapsed){var c=new CKEDITOR.dom.text(e.title,s.document);l[0].insertNode(c),l[0].selectNodeContents(c),f.selectRanges(l)}var h=new CKEDITOR.style({element:"a",attributes:e});h.type=CKEDITOR.STYLE_INLINE,h.apply(s.document)}else{var p=this._.selectedElement;if(CKEDITOR.env.ie&&e.name!=p.getAttribute("name")){var d=new CKEDITOR.dom.element('<a name="'+CKEDITOR.tools.htmlEncode(e.name)+'">',s.document);f=s.getSelection(),p.moveChildren(d),p.copyAttributes(d,{name:1}),d.replace(p),p=d,f.selectElement(p)}p.setAttributes(e),p.removeAttributes(t),p.getAttribute("title")&&p.setHtml(p.getAttribute("title")),p.getAttribute("name")?p.addClass("cke_anchor"):p.removeClass("cke_anchor"),this.fakeObj&&s.createFakeElement(p,"cke_anchor","anchor").replace(this.fakeObj),delete this._.selectedElement}},contents:[{label:e.lang.common.generalTab,id:"general",accessKey:"I",elements:[{type:"vbox",padding:0,children:[{type:"html",html:"<span>"+CKEDITOR.tools.htmlEncode(e.lang.attachment.url)+"</span>"},{type:"hbox",widths:["280px","110px"],align:"right",children:[{id:"src",type:"text",label:"",validate:CKEDITOR.dialog.validate.notEmpty(e.lang.flash.validateSrc),setup:function(e){e.url&&this.setValue(e.url),this.select()},commit:function(e){e.url=this.getValue()}},{type:"button",id:"browse",filebrowser:"general:src",hidden:!0,align:"center",label:e.lang.common.browseServer}]}]},{type:"vbox",padding:0,children:[{id:"name",type:"text",label:e.lang.attachment.name,setup:function(e){e.title&&this.setValue(e.title)},commit:function(e){e.title=this.getValue()}}]},{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:e.lang.link.target,"default":"notSet",style:"width : 100%;",items:[[e.lang.link.targetNotSet,"notSet"],[e.lang.link.targetFrame,"frame"],[e.lang.link.targetNew,"_blank"],[e.lang.link.targetTop,"_top"],[e.lang.link.targetSelf,"_self"],[e.lang.link.targetParent,"_parent"]],onChange:r,setup:function(e){e.target&&this.setValue(e.target.type)},commit:function(e){e.target||(e.target={}),e.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:e.lang.link.targetFrameName,"default":"",setup:function(e){e.target&&this.setValue(e.target.name)},commit:function(e){e.target||(e.target={}),e.target.name=this.getValue()}}]}]},{id:"Upload",hidden:!0,filebrowser:"uploadButton",label:e.lang.common.upload,elements:[{type:"file",id:"upload",label:e.lang.common.upload,size:38},{type:"fileButton",id:"uploadButton",label:e.lang.common.uploadSubmit,filebrowser:"general:src","for":["Upload","upload"]}]}]}})})();